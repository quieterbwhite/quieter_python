# 数据库分库分表
> http://blog.720ui.com/2017/mysql_core_08_multi_db_table/  
> http://blog.720ui.com/2017/mysql_core_09_multi_db_table2/  

面对海量数据，例如，上千万甚至上亿的数据，查询一次所花费的时间会变长，甚至会造成数据库的单点压力。
因此，分库与分表的目的在于，减小数据库的单库单表负担，提高查询性能，缩短查询时间。

## 分表概述
```
随着用户数的不断增加，以及数据量的不断增加，会使得单表压力越来越大，面对上千万甚至上亿的数据，查询一次所花费的时间会变长，如果有联合查询的情况下，甚至可能会成为很大的瓶颈。
此外，MySQL 存在表锁和行锁，因此更新表数据可能会引起表锁或者行锁，这样也会导致其他操作等待，甚至死锁问题。

通过分表，可以减少数据库的单表负担，将压力分散到不同的表上，同时因为不同的表上的数据量少了，起到提高查询性能，缩短查询时间的作用，此外，可以很大的缓解表锁的问题。

分表策略可以归纳为垂直拆分和水平拆分。

垂直拆分

    把表的字段进行拆分，即一张字段比较多的表拆分为多张表，这样使得行数据变小。

    一方面，可以减少客户端程序和数据库之间的网络传输的字节数，因为生产环境共享同一个网络带宽，随着并发查询的增多，有可能造成带宽瓶颈从而造成阻塞。

    另一方面，一个数据块能存放更多的数据，在查询时就会减少 I/O 次数。
    举个例子，假设用户表中有一个字段是家庭地址，这个字段是可选字段，在数据库操作的时候除了个人信息外，并不需要经常读取或是更改这个字段的值。在这种情况下，更建议把它拆分到另外一个表，从而提高性能。

    如何设计好垂直拆分，我的建议：

        将不常用的字段单独拆分到另外一张扩展表，例如前面讲解到的用户家庭地址，这个字段是可选字段，在数据库操作的时候除了个人信息外，并不需要经常读取或是更改这个字段的值。

        将大文本的字段单独拆分到另外一张扩展表，例如 BLOB 和 TEXT 字符串类型的字段，以及 TINYBLOB、 MEDIUMBLOB、 LONGBLOB、 TINYTEXT、 MEDIUMTEXT、 LONGTEXT字符串类型。这样可以减少客户端程序和数据库之间的网络传输的字节数。

        将不经常修改的字段放在同一张表中，将经常改变的字段放在另一张表中。
        举个例子，假设用户表的设计中，还存在“最后登录时间”字段，每次用户登录时会被更新。
        这张用户表会存在频繁的更新操作，此外，每次更新时会导致该表的查询缓存被清空。
        所以，可以把这个字段放到另一个表中，这样查询缓存会增加很多性能。

        对于需要经常关联查询的字段，建议放在同一张表中。不然在联合查询的情况下，会带来数据库额外压力。

水平拆分

    把表的行进行拆分。因为表的行数超过几百万行时，就会变慢，这时可以把一张的表的数据拆成多张表来存放。
    水平拆分，有许多策略，例如，取模分表，时间维度分表，以及自定义 Hash 分表，例如用户 ID 维度分表等。
    在不同策略分表情况下，根据各自的策略写入与读取。

    注意: 水平分表过后的数据读取，翻页问题。

实际上，垂直拆分后的表依然存在单表数据量过大的问题，需要进行水平拆分。
因此，实际情况中，水平拆分往往会和垂直拆分结合使用。
假设，随着用户数的不断增加，用户表单表存在上千万的数据，这时可以把一张用户表的数据拆成多张用户表来存放。

常见的水平分表策略归纳起来，可以总结为随机分表和连续分表两种情况。
例如，取模分表就属于随机分表，而时间维度分表则属于连续分表。

连续分表
    可以快速定位到表进行高效查询，大多数情况下，可以有效避免跨表查询。
    如果想扩展，只需要添加额外的分表就可以了，无需对其他分表的数据进行数据迁移。
    但是，连续分表有可能存在数据热点的问题，有些表可能会被频繁地查询从而造成较大压力，热数据的表就成为了整个库的瓶颈，而有些表可能存的是历史数据，很少需要被查询到。

随机分表
    是遵循规则策略进行写入与读取，而不是真正意义上的随机。
    通常，采用取模分表或者自定义 Hash 分表的方式进行水平拆分。
    随机分表的数据相对比较均匀，不容易出现热点和并发访问的瓶颈。
    但是，分表扩展需要迁移旧的数据。此外，随机分表比较容易面临跨表查询的复杂问题。

对于日志场景，可以考虑根据时间维度分表，例如年份维度分表或者月份维度分表，
在日志记录表的名字中包含年份和月份的信息，例如 log_2017_01，这样可以在已经没有新增操作的历史表上做频繁地查询操作，而不会影响时间维度分表上新增操作。

对于海量用户场景，可以考虑取模分表，数据相对比较均匀，不容易出现热点和并发访问的瓶颈。

对于租户场景，可以考虑租户维度分表，不同的租户数据独立，而不应该在每张表中添加租户 ID，这是一个不错的选择。
```

## 分库概述
```
库内分表，仅仅是解决了单表数据过大的问题，但并没有把单表的数据分散到不同的物理机上，因此并不能减轻 MySQL 服务器的压力，仍然存在同一个物理机上的资源竞争和瓶颈，包括 CPU、内存、磁盘 IO、网络带宽等。

分库策略也可以归纳为垂直拆分和水平拆分。

垂直拆分，按照业务和功能划分，把数据分别放到不同的数据库中。举个例子，可以划分资讯库、百科库等。

水平拆分，把一张表的数据划分到不同的数据库，两个数据库的表结构一样。
实际上，水平分库与水平分表类似，水平拆分有许多策略，例如，取模分库，自定义 Hash 分库等，在不同策略分库情况下，根据各自的策略写入与读取。
举个例子，随着业务的增长，资讯库的单表数据过大，此时采取水平拆分策略，根据取模分库。
```

随着用户数的不断增加，以及数据量的不断增加，通过分库与分表的方式提高查询性能的同时，带来了一系列分布式困境。

## 数据迁移与扩容问题
```
前面介绍到水平分表策略归纳总结为随机分表和连续分表两种情况。

连续分表有可能存在数据热点的问题，有些表可能会被频繁地查询从而造成较大压力，热数据的表就成为了整个库的瓶颈，而有些表可能存的是历史数据，很少需要被查询到。
连续分表的另外一个好处在于比较容易，不需要考虑迁移旧的数据，只需要添加分表就可以自动扩容。

随机分表的数据相对比较均匀，不容易出现热点和并发访问的瓶颈。但是，分表扩展需要迁移旧的数据。
针对于水平分表的设计至关重要，需要评估中短期内业务的增长速度，对当前的数据量进行容量规划，综合成本因素，推算出大概需要多少分片。
对于数据迁移的问题，一般做法是通过程序先读出数据，然后按照指定的分表策略再将数据写入到各个分表中。
```

## 表关联问题
```
在单库单表的情况下，联合查询是非常容易的。
但是，随着分库与分表的演变，联合查询就遇到跨库关联和跨表关系问题。
在设计之初就应该尽量避免联合查询，可以通过程序中进行拼装，或者通过反范式化设计进行规避。
```

## 分页与排序问题
```
一般情况下，列表分页时需要按照指定字段进行排序。
在单库单表的情况下，分页和排序也是非常容易的。
但是，随着分库与分表的演变，也会遇到跨库排序和跨表排序问题。
为了最终结果的准确性，需要在不同的分表中将数据进行排序并返回，并将不同分表返回的结果集进行汇总和再次排序，最后再返回给用户。
```

## 分布式事务问题
```
随着分库与分表的演变，一定会遇到分布式事务问题，那么如何保证数据的一致性就成为一个必须面对的问题。
目前，分布式事务并没有很好的解决方案，难以满足数据强一致性，
一般情况下，使存储数据尽可能达到用户一致，保证系统经过一段较短的时间的自我恢复和修正，数据最终达到一致。
```

## 分布式全局唯一ID
```
在单库单表的情况下，直接使用数据库自增特性来生成主键ID，这样确实比较简单。
在分库分表的环境中，数据分布在不同的分表上，不能再借助数据库自增长特性。
需要使用全局唯一 ID，例如 UUID、GUID等。
```

分库与分表主要用于应对当前互联网常见的两个场景：  
海量数据和高并发。  
然而，分库与分表是一把双刃剑，虽然很好的应对海量数据和高并发对数据库的冲击和压力，但是却提高的系统的复杂度和维护成本。  

需要结合实际需求，不宜过度设计，在项目一开始不采用分库与分表设计，  
而是随着业务的增长，在无法继续优化的情况下，再考虑分库与分表提高系统的性能。  

## 分库分表的几种方式
```
把一个实例中的多个数据库拆分到不同的实例

    订单数据库

    用户数据库

    促销数据库

一个库中的表分离到不同的数据库中

    订单数据库实例

    用户数据库实例

    促销数据库实例

对一个库中的相关表进行水平拆分到不同实例的数据库中

    如何选择分区键

        分区键要能尽量避免跨分区片查询的发生

        分区键要能尽量使各个分片中的数据平均

    如何存储无需分片的表

        每个分片中存储一份相同的数据(冗余数据，查询高效)

        使用额外的节点同一存储(不冗余数据，数据还需要放到内存中处理)

    如何在节点上部署分片

        每个分片使用单一数据库，并且数据库名也相同

        将多个分片表存储在一个数据库中，并在表名上加入分片号后缀

        在一个节点中部署多个数据库，每个数据库包含一个分片

    如何分配分片中的数据

        按分区键的Hash值取模来分配分片数据

        按分区键的范围来分配分片数据

        利用分区键和分片的映射表来分配分片数据

    如何生成全局唯一id

        使用auto_increment_increment和auto_increment_offset参数

        使用全局节点来生成ID

        在Redis等缓存服务器中创建全局ID
```

