服务器硬件对MYSQL性能的影响

事务的隔离性

未提交读(READ UNCOMMITTED)

    基本不用

# 显示当前隔离级别
show variables like '%iso%';

output:
    tx_isolation    REPEATABLE-READ(可重复读)

    开启一个进程A，开启事务，查询数据，返回res1

    开启另一个进程B，开启事务，修改数据并提交

    在进程A中再次查询数据，结果仍为res1

# 修改隔离级别 -> 读已提交
set session tx_isolation = 'read-committed';

show variables like '%iso%';

再次进行上面的实验，最后读到的结果包含最新的数据！

可串行化(SERIALIZABLE)

    最高的隔离级别

    会在读取的每行数据行加锁，可能会导致大量锁超时，和锁争用问题
    所以在实际业务中很少使用这个隔离级别，除非是严格要求数据一致性

InnoDB 的默认隔离级别是可重复读.

----------------------------------------------------------------

什么是大事务

    定义：运行时间比较长，操作的数据比较多的事务。
    风险：
        锁定太多数据，造成大量的阻塞和锁超时
        回滚时所需的时间比较长
        执行时间长，容易造成主从延迟

如何处理大事务

    避免一次处理太多数据

    移除不必要在事务中事务中的select操作

----------------------------------------------------------------

影响性能因素

硬件环境

服务器系统

数据库存储引擎的选择

    MyISAM，不支持事务，表级锁
    InnoDB，事务级存储引擎，完美支持行级锁，事务ACID特性

数据库参数配置(影响最大)

数据库结构设计和SQL语句

----------------------------------------------------------------

cpu资源和可用内存大小

如何选择cpu

    cpu密集型？

        更好的cpu，而不是更多的cpu
        目前的mysql，还不支持多cpu对同一sql并发处理，所以更多的cpu显然没有帮助

    我们系统的并发量？

        web类应用，核心数量比频率更加重要，多个cpu同时执行多个sql

    我们使用过的mysql的版本？

        >= 5.6， 对多核的支持有了很大的改善

    64位使用32位的服务器版本？

        32位系统不能使用更大内存，进程都不能寻址到xx位以上的内存，
        对mysql有极大的限制

内存

    内存的io效率远远高于磁盘

    内存， ssd， Fusion-IO

    常用mysql存储引擎

        MyISAM
            索引 -> 内存
            数据 -> 通过操作系统进行缓存

        InnoDB
            索引 -> 内存
            数据 -> 内存
            提供数据库运行效率

        缓存对读，写都是有益的

        写入到内存中的数据虽然始终要写入磁盘，但是更大的内存意味着，
        可以批量写内存中的数据到磁盘。合并写入，减少写磁盘次数，增大性能。

    内存主频

        频率越高速度越快

        选择内存时应该选择主板支持的最大内存频率
        
        服务器内存
            组成购买升级
            每个通道的内存，相同品牌，颗粒
            频率，电压，校验技术和型号
            单条容量尽可能大（成本）

    根据数据库大小选择内存

        热数据120G, 那么选择128G内存就足够了，但是考虑到数据不停增长，需要更大

磁盘的配置和选择

    使用传统机械硬盘

    使用RAID增强传统机械硬盘的性能

    使用固态存储SDD和PCie卡

    使用网络存储NAS和SAN

使用传统机械硬盘

    最常见，使用最多，价格低，存储空间大
    
    读写慢，速度取决于他的工作机制

    传统机械硬盘读取数据的工程
        1. 移动磁头到磁盘表面上的正确位置
        2. 等待磁盘旋转，使所需的数据在磁头之下
        3. 等待磁盘旋转过去，所有所需的数据都被磁头读出

        step，1.2， 访问时间
        step，3，传输速度

    如何选择传统磁盘

        1. 存储容量，不会是瓶颈
        2. 传输速度，
        3. 访问时间
        4. 主轴的转速，常用7200,15000,15000已经是目前最好的选择了
        5. 物理尺寸，越小速度越快，也意味着单盘的空间也小一些

使用RAID增强传统机械硬盘的性能

    什么是RAID

        RAID是磁盘冗余队列的简称(Redundent Arrays of Independent Disks)
        简单来说RAID的作用就是可以将多个容量较小的磁盘组成一组容量更大的磁盘，
        并提供数据冗余来保证数据完整性的技术
        也就是提供更小尺寸磁盘的访问速度，并获得更大的存储空间

    RAID 0

        是组建磁盘阵列中最简单的一种形式
        >= 2 个独立的磁盘串联在一起
        成本低，可以提高整个磁盘的性能和吞吐量
        没有提供冗余和错误修复能力，但实现成本是最低的

    RAID 1

        又称磁盘镜像
        原理是把一个磁盘上的数据镜像到另一个磁盘上，
        也即是说数据在写入一块磁盘的同时，会在另一块闲置的磁盘上生成镜像文件，
        在不影响性能情况下最大限度的保证系统的可靠性和可修复性

    RAID 5

        分布式奇偶校验磁盘阵列
        通过分布式奇偶校验块把数据分散到多个磁盘上，
        这样如果任何一个盘数据失效，都可以从奇偶校验块中重建。
        但是如果两块盘失效，则整个卷的数据都无法恢复

    RAID 10

        分片的镜像，常用，最好的选择
        它是对磁盘先做RAID 1之后，对两组RAID 1的磁盘在做 RAID 0，
        所以对读写都有良好的性能，相对于RAID 5重建起来更简单，速度也更快。

    RAID 0 ，便宜，快速，危险。读快，写快
    RAID 1 ，高速读，简单，安全。读快，写慢
    RAID 5 ，安全，成本折中。读快，写取决于最慢的盘
    RAID 10 ，贵，高速，安全。读快，写快
        
固态存储

    SSD， PCI-E SSD

    相比机械硬盘，固态磁盘有更好的随机读写性能
    相比机械磁盘，固态磁盘能更好的支持并发
    相比机械磁盘，固态磁盘更容易损坏

    固态磁盘的特点：

        1. 使用SATA接口
            可以替换传统磁盘而不需任何改变
            但是会收到接口速率限制，如：
                SATA3.0 6Gbps -> SATA2.0 3Gbps

        2. 由于接口相同，SATA接口的SSD同样支持RAID技术

    PCI-E SSD

        Fusion-IO 卡是使用闪存技术的 PCI-E 卡设备

        无法使用SATA接口，需要独特的驱动和配置

        价格相对于SSD要贵
        但是性能比SSD更好

        占用服务器内存，几十G

        不需要使用RAID，成本高

    使用场景

        适用于存在大量随机IO的场景
        使用于解决单线程负载的IO瓶颈

网络存储SAN和NAS

    SAN, Storage Area Network 和 NAS, Network Attached Storage
    是两种外部文件存储设备加载到服务器上的方法

    SAN （访问，光纤）服务器（硬盘）SAN
    SAN设备通过光纤连接到服务器，设备通过块接口访问，服务器可以将其当做硬盘使用

    大量顺序读写，读写IO，缓存，IO合并，随机读写慢，不如本地RAID磁盘

    NAS设备使用网络连接，通过基于文件的协议如NFS或SMB来访问

    网络存储适用的场景

        数据库备份

网络对性能的影响

    磁盘性能的限制：延迟，吞吐量

    网络性能的限制：延迟，带宽

        512k， 10M 的网络

    web服务器和数据库服务器是通过网络来进行连接的，如果网络带宽不足，就会延迟

    即使内网环境，在比如大促销场景下，带宽也可能成为瓶颈

    如1000M的带宽，50台服务器，那么每台分2M都把带宽耗尽了

    网络的质量对性能的影响，比如经常丢包，就会导致大量网络包的重复发送，
    从另一个方面增加了网络负担，而且这种情况一旦发生，就会越难以控制，
    从而形成网络风暴，对整个网络环境下的服务器都会产生影响
    
    建议：
        1. 采用高性能和高带宽的网络接口设备和交换机，和核心交换机万M的设备
        2. 对多个网卡进行绑定，增强可用性和带宽。
            绑定后在系统中把多个网卡当做一个网卡来使用，不仅增加网卡的带宽，
            更重要的是增加网卡的冗余，当一个网卡出现问题时不至于影响整个服务器的使用
        3. 尽可能进行网络的隔离，特别是对内外网进行隔离

总结

    CPU：
        1. 64位的CPU一定要工作在64位的操作系统下
        2. 对于并发比较高的场景，CPU的数量比频率重要
        3. 对于CPU密集型场景和复杂sql，则频率越高越好

    内存：
        1. 选择主板所能使用的频率最高的内存
        2. 内存的大小对性能很重要，所以尽可能的大

    IO子系统：
        1. PCIe -> SSD -> RAID10 -> 磁盘 -> SAN 










